name: PR Quality Check

on:
  pull_request:
    branches: [ main ]

jobs:
  quality-check:
    name: Code Quality & Extension Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: TypeScript type checking
      id: typescript-check
      run: npx tsc --noEmit
      
    - name: ESLint code quality
      id: eslint-check
      run: npm run lint
      
    - name: Build extension
      id: build-extension
      run: npm run compile
      
    - name: Validate extension package
      id: validate-package
      run: |
        npm install -g @vscode/vsce
        vsce package --no-dependencies
        
    - name: Check package.json validity
      id: check-package
      run: |
        node -e "
          const pkg = require('./package.json');
          if (!pkg.publisher) throw new Error('Missing publisher in package.json');
          if (!pkg.version) throw new Error('Missing version in package.json');
          if (!pkg.engines?.vscode) throw new Error('Missing vscode engine requirement');
          console.log('âœ… Package.json validation passed');
        "
        
    - name: Validate MCP configuration
      id: validate-mcp
      run: |
        if [ ! -f ".vscode/mcp.json" ]; then
          echo "âŒ Missing .vscode/mcp.json configuration"
          exit 1
        fi
        echo "âœ… MCP configuration found"
        
    - name: Check for sensitive data
      run: |
        # Check for potential secrets or API keys
        if grep -r "ghp_\|github_pat_\|sk-" src/ --exclude-dir=node_modules || true; then
          echo "âš ï¸  Potential secrets detected in source code"
          echo "Please ensure no API keys are committed"
        fi
        
    - name: Extension size check
      run: |
        VSIX_SIZE=$(stat -c%s *.vsix)
        MAX_SIZE=$((50 * 1024 * 1024))  # 50MB limit
        if [ $VSIX_SIZE -gt $MAX_SIZE ]; then
          echo "âŒ Extension package too large: $(($VSIX_SIZE / 1024 / 1024))MB (max 50MB)"
          exit 1
        fi
        echo "âœ… Extension size OK: $(($VSIX_SIZE / 1024 / 1024))MB"
        
    - name: Comment PR with results
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const fs = require('fs');
          const vsixFiles = fs.readdirSync('.').filter(f => f.endsWith('.vsix'));
          const vsixFile = vsixFiles[0] || 'Not generated';
          
          const tsCheck = '${{ steps.typescript-check.outcome }}' === 'success' ? 'âœ… Passed' : 'âŒ Failed';
          const lintCheck = '${{ steps.eslint-check.outcome }}' === 'success' ? 'âœ… Passed' : 'âŒ Failed';
          const buildCheck = '${{ steps.build-extension.outcome }}' === 'success' ? 'âœ… Passed' : 'âŒ Failed';
          const packageCheck = '${{ steps.validate-package.outcome }}' === 'success' ? 'âœ… Passed' : 'âŒ Failed';
          const configCheck = '${{ steps.validate-mcp.outcome }}' === 'success' ? 'âœ… Passed' : 'âŒ Failed';
          
          const allPassed = '${{ steps.typescript-check.outcome }}' === 'success' && 
                           '${{ steps.eslint-check.outcome }}' === 'success' && 
                           '${{ steps.build-extension.outcome }}' === 'success' &&
                           '${{ steps.validate-package.outcome }}' === 'success';
          
          const body = `## ğŸ” Extension Quality Check Results
          
          ### âœ… Validation Status
          - **TypeScript Compilation**: ${tsCheck}
          - **ESLint Quality Check**: ${lintCheck}
          - **Extension Packaging**: ${buildCheck}
          - **Package.json Validation**: ${packageCheck}
          - **MCP Configuration**: ${configCheck}
          
          ### ğŸ“¦ Extension Details
          - **Generated VSIX**: \`${vsixFile}\`
          - **Publisher**: Ready for marketplace submission
          - **MCP Integration**: Configured for GitHub MCP Server
          
          ### ğŸ¯ Next Steps
          ${allPassed 
            ? 'âœ¨ This PR has passed all quality checks and is ready for review.' 
            : 'ğŸ”§ Please fix the issues above before merging.'}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
